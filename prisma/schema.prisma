// Minsah Beauty - Prisma Schema
// PostgreSQL Database for Dokploy Deployment

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// User & Authentication Models
// ==========================================

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  emailVerified   DateTime?
  passwordHash    String?   // Null for social login users
  firstName       String?
  lastName        String?
  phone           String?
  dateOfBirth     DateTime?
  gender          String?
  avatar          String?
  phoneVerified   Boolean   @default(false)
  role            UserRole  @default(CUSTOMER)
  status          UserStatus @default(ACTIVE)
  loyaltyPoints   Int       @default(0)
  referralCode    String?   @unique
  referredById    String?
  referredBy      User?     @relation("Referrals", fields: [referredById], references: [id])
  referrals       User[]    @relation("Referrals")

  // Preferences
  newsletter          Boolean @default(true)
  smsNotifications    Boolean @default(false)
  promotions          Boolean @default(true)
  newProducts         Boolean @default(true)
  orderUpdates        Boolean @default(true)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastLoginAt     DateTime?

  // Relations
  accounts        Account[]
  sessions        Session[]
  addresses       Address[]
  orders          Order[]
  cartItems       CartItem[]
  wishlistItems   WishlistItem[]
  reviews         Review[]
  refreshTokens   RefreshToken[]

  @@index([email])
  @@index([referralCode])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)

  @@index([email])
  @@index([token])
}

// ==========================================
// Admin Models
// ==========================================

model AdminUser {
  id           String      @id @default(cuid())
  email        String      @unique
  passwordHash String
  name         String
  avatar       String?
  role         AdminRole   @default(STAFF)
  status       UserStatus  @default(ACTIVE)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  lastLoginAt  DateTime?

  refreshTokens AdminRefreshToken[]

  @@index([email])
}

model AdminRefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  adminId   String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)

  admin AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([token])
}

// ==========================================
// Address Model
// ==========================================

model Address {
  id          String      @id @default(cuid())
  userId      String
  type        AddressType @default(SHIPPING)
  isDefault   Boolean     @default(false)
  firstName   String
  lastName    String
  company     String?
  street1     String
  street2     String?
  city        String
  state       String
  postalCode  String
  country     String      @default("Bangladesh")
  phone       String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders      Order[]

  @@index([userId])
}

// ==========================================
// Product Models
// ==========================================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  isActive    Boolean    @default(true)
  sortOrder   Int        @default(0)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products    Product[]

  @@index([slug])
  @@index([parentId])
}

model Brand {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  logo        String?
  website     String?
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@index([slug])
}

model Product {
  id              String          @id @default(cuid())
  sku             String          @unique
  name            String
  slug            String          @unique
  description     String?         @db.Text
  shortDescription String?
  price           Decimal         @db.Decimal(10, 2)
  compareAtPrice  Decimal?        @db.Decimal(10, 2)
  costPrice       Decimal?        @db.Decimal(10, 2)

  // Inventory
  quantity        Int             @default(0)
  lowStockThreshold Int           @default(5)
  trackInventory  Boolean         @default(true)
  allowBackorder  Boolean         @default(false)

  // Physical attributes
  weight          Decimal?        @db.Decimal(10, 3)
  length          Decimal?        @db.Decimal(10, 2)
  width           Decimal?        @db.Decimal(10, 2)
  height          Decimal?        @db.Decimal(10, 2)

  // Status
  isActive        Boolean         @default(true)
  isFeatured      Boolean         @default(false)
  isNew           Boolean         @default(false)

  // SEO
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  // Relations
  categoryId      String?
  category        Category?       @relation(fields: [categoryId], references: [id])
  brandId         String?
  brand           Brand?          @relation(fields: [brandId], references: [id])

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  images          ProductImage[]
  variants        ProductVariant[]
  cartItems       CartItem[]
  wishlistItems   WishlistItem[]
  orderItems      OrderItem[]
  reviews         Review[]

  @@index([slug])
  @@index([sku])
  @@index([categoryId])
  @@index([brandId])
  @@index([isActive, isFeatured])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  alt       String?
  sortOrder Int      @default(0)
  isDefault Boolean  @default(false)

  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductVariant {
  id              String   @id @default(cuid())
  productId       String
  sku             String   @unique
  name            String
  price           Decimal? @db.Decimal(10, 2)
  quantity        Int      @default(0)
  attributes      Json?    // { color: "Red", size: "M" }
  image           String?

  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems       CartItem[]
  orderItems      OrderItem[]

  @@index([productId])
  @@index([sku])
}

// ==========================================
// Cart Models
// ==========================================

model CartItem {
  id        String          @id @default(cuid())
  userId    String
  productId String
  variantId String?
  quantity  Int             @default(1)

  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([userId, productId, variantId])
  @@index([userId])
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
}

// ==========================================
// Order Models
// ==========================================

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  userId          String
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String?

  // Totals
  subtotal        Decimal       @db.Decimal(10, 2)
  shippingCost    Decimal       @default(0) @db.Decimal(10, 2)
  taxAmount       Decimal       @default(0) @db.Decimal(10, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)

  // Shipping
  addressId       String?
  shippingAddress Address?      @relation(fields: [addressId], references: [id])
  shippingMethod  String?
  trackingNumber  String?

  // Coupon
  couponCode      String?
  couponDiscount  Decimal?      @db.Decimal(10, 2)

  // Notes
  customerNote    String?
  adminNote       String?       @db.Text

  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  paidAt          DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?

  user            User          @relation(fields: [userId], references: [id])
  items           OrderItem[]
  payments        Payment[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id          String          @id @default(cuid())
  orderId     String
  productId   String
  variantId   String?
  name        String
  sku         String
  price       Decimal         @db.Decimal(10, 2)
  quantity    Int
  total       Decimal         @db.Decimal(10, 2)

  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product         @relation(fields: [productId], references: [id])
  variant     ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
}

model Payment {
  id                String        @id @default(cuid())
  orderId           String
  method            String
  status            PaymentStatus @default(PENDING)
  amount            Decimal       @db.Decimal(10, 2)
  transactionId     String?
  gatewayResponse   Json?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([transactionId])
}

// ==========================================
// Review Model
// ==========================================

model Review {
  id          String   @id @default(cuid())
  userId      String
  productId   String
  rating      Int
  title       String?
  comment     String?  @db.Text
  isVerified  Boolean  @default(false)
  isApproved  Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([isApproved])
}

// ==========================================
// Coupon Model
// ==========================================

model Coupon {
  id              String       @id @default(cuid())
  code            String       @unique
  description     String?
  type            CouponType   @default(PERCENTAGE)
  value           Decimal      @db.Decimal(10, 2)
  minPurchase     Decimal?     @db.Decimal(10, 2)
  maxDiscount     Decimal?     @db.Decimal(10, 2)
  usageLimit      Int?
  usageCount      Int          @default(0)
  perUserLimit    Int?
  startDate       DateTime?
  endDate         DateTime?
  isActive        Boolean      @default(true)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([code])
  @@index([isActive])
}

// ==========================================
// Enums
// ==========================================

enum UserRole {
  CUSTOMER
  VIP
  PREMIUM
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  STAFF
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum AddressType {
  SHIPPING
  BILLING
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum CouponType {
  PERCENTAGE
  FIXED
  FREE_SHIPPING
}
